<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nagaja.admin.mapper.MemberMapper">

    <!--TODO 멤버 카운트-->
    <select id="memberCount" resultType="int">
        SELECT COUNT(*) FROM member m
        LEFT JOIN nation_info ni ON m.nation_info_id = ni.nation_info_id
        <where>
            <if test="member.startDate != null and !member.startDate.equals('')">
                <![CDATA[
                    AND DATE(m.mem_create_date) >= DATE(#{member.startDate})
                ]]>
            </if>

            <if test="member.endDate != null and !member.endDate.equals('')">
                <![CDATA[
                    AND DATE(m.mem_create_date) <= DATE(#{member.endDate})
                ]]>
            </if>

            <choose>
                <when test="member.memStatusId != null and member.memStatusId != 0">
                    AND m.mem_status_id = #{member.memStatusId}
                </when>
                <otherwise>
                    AND (m.mem_status_id = 1 OR m.mem_status_id = 2 OR m.mem_status_id = 3 OR m.mem_status_id = 7)
                </otherwise>
            </choose>

            <choose>
                <when test="member.keywordFilter == 1">
                    AND m.mem_number LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 2">
                    AND m.mem_name LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 3">
                    AND m.mem_login_id LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 4">
                    AND m.mem_phone LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 5">
                    AND ni.nation_info_name LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 6">
                    AND m.mem_address LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 7">
                    AND m.mem_email LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 8">
                    AND m.mem_nickname LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
            </choose>
        </where>
    </select>

    <!--TODO 멤버 리스트-->
    <select id="memberList" resultType="MemberInfoDto">
        SELECT * FROM member m
        LEFT JOIN nation_info ni ON m.nation_info_id = ni.nation_info_id
        <where>
            <if test="member.startDate != null and !member.startDate.equals('')">
                <![CDATA[
                    AND DATE(m.mem_create_date) >= DATE(#{member.startDate})
                ]]>
            </if>

            <if test="member.endDate != null and !member.endDate.equals('')">
                <![CDATA[
                    AND DATE(m.mem_create_date) <= DATE(#{member.endDate})
                ]]>
            </if>

            <choose>
                <when test="member.memStatusId != null and member.memStatusId != 0">
                    AND m.mem_status_id = #{member.memStatusId}
                </when>
                <otherwise>
                    AND (m.mem_status_id = 1 OR m.mem_status_id = 2 OR m.mem_status_id = 3 OR m.mem_status_id = 7)
                </otherwise>
            </choose>

            <choose>
                <when test="member.keywordFilter == 1">
                    AND m.mem_number LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 2">
                    AND m.mem_name LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 3">
                    AND m.mem_login_id LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 4">
                    AND m.mem_phone LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 5">
                    AND ni.nation_info_name LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 6">
                    AND m.mem_address LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 7">
                    AND m.mem_email LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
                <when test="member.keywordFilter == 8">
                    AND m.mem_nickname LIKE CONCAT ('%', #{member.keyword}, '%')
                </when>
            </choose>
        </where>
        ORDER BY m.mem_create_date DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!--TODO 멤버 설렉트-->
    <select id="selectMember" parameterType="int" resultType="MemberInfoDto">
        SELECT *,(SELECT COUNT(*) FROM regular r WHERE r.mem_id = m.mem_id) AS regulars
        FROM member m
        LEFT JOIN nation_info ni ON m.nation_info_id = ni.nation_info_id
        LEFT JOIN member_status ms ON m.mem_status_id = ms.mem_status_id
        WHERE m.mem_id = #{memId}
    </select>

    <!--TODO 멤버 ALL 설렉트-->
    <select id="selectAllMember" resultType="MemberInfoDto">
        SELECT * FROM member m
        LEFT JOIN nation_info ni ON m.nation_info_id = ni.nation_info_id
        WHERE mem_status_id = 1 OR mem_status_id = 2 OR mem_status_id = 3 OR mem_status_id = 7
    </select>

    <!--TODO 멤버 블랙리스트 등록/해제-->
    <update id="memberBlackList" parameterType="int">
        <selectKey  keyProperty="status" resultType="integer" order="BEFORE">
            SELECT mem_status_id FROM member
            WHERE mem_id = #{memId}
        </selectKey>
        UPDATE member
        SET
        <choose>
            <!-- TODO 유저일반일시-->
            <when test="status == 1">
                mem_status_id = 3
            </when>
            <!-- TODO 유저블랙일시-->
            <when test="status == 3">
                mem_status_id = 1
            </when>
            <!-- TODO 기업일반일시-->
            <when test="status == 4">
                mem_status_id = 6
            </when>
            <!-- TODO 기업블랙일시-->
            <when test="status == 6">
                mem_status_id = 4
            </when>
        </choose>
        WHERE mem_id = #{memId}
    </update>

    <!--TODO 멤버 탈퇴-->
    <update id="memberSecession" parameterType="int">
        <selectKey  keyProperty="status" resultType="integer" order="BEFORE">
            SELECT mem_status_id FROM member
            WHERE mem_id = #{memId}
        </selectKey>
        UPDATE member
        SET
            <choose>
                <when test="status == 1 or status == 3 or status == 7">
                    mem_status_id = 2
                </when>
                <otherwise>
                    mem_status_id = 5
                </otherwise>
            </choose>
        WHERE mem_id = #{memId}
    </update>

</mapper>