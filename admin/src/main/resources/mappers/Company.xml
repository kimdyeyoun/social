<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nagaja.admin.mapper.CompanyMapper">


    <!--TODO 기업회원 카운트-->
    <select id="companyCount" resultType="int">
        SELECT COUNT(*) FROM company c
        LEFT JOIN member m ON m.mem_id = c.mem_id
        LEFT JOIN company_name cn ON cn.company_id = c.company_id
        LEFT JOIN nation_info ni ON ni.nation_info_id = m.nation_info_id
        LEFT JOIN member_status ms ON ms.mem_status_id = m.mem_status_id
        LEFT JOIN board_category bc ON bc.board_category_id = c.board_category_id
        <where>
            c.company_status = 2
            <if test="company.startDate != null and !company.startDate.equals('')">
                <![CDATA[
                        AND DATE(c.company_approval_date) >= DATE(#{company.startDate})
                    ]]>
            </if>

            <if test="company.endDate != null and !company.endDate.equals('')">
                <![CDATA[
                        AND DATE(c.company_approval_date) <= DATE(#{company.endDate})
                    ]]>
            </if>

            <!--TODO 주소 미정-->
            <if test="company.nationInfoId != null and company.nationInfoId != 0">
                AND m.nation_info_id = #{company.nationInfoId}
            </if>

            <choose>
                <when test="company.memStatusId != null and company.memStatusId != 0">
                    AND m.mem_status_id = #{company.memStatusId}
                </when>
                <otherwise>
                    AND (m.mem_status_id = 4 OR m.mem_status_id = 5 OR m.mem_status_id = 6)
                </otherwise>
            </choose>

            <choose>
                <when test="company.keywordFilter == 1">
                    AND m.mem_login_id LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 2">
                    AND bc.board_category_title LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 3">
                    AND (cn.company_name_eng LIKE CONCAT ('%', #{company.keyword}, '%') OR
                         cn.company_name_kor LIKE CONCAT ('%', #{company.keyword}, '%') OR
                         cn.company_name_php LIKE CONCAT ('%', #{company.keyword}, '%') OR
                         cn.company_name_chn LIKE CONCAT ('%', #{company.keyword}, '%') OR
                         cn.company_name_jpn LIKE CONCAT ('%', #{company.keyword}, '%'))
                </when>
                <when test="company.keywordFilter == 4">
                    AND c.company_address LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 5">
                    AND c.company_phone LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
            </choose>
        </where>
    </select>

    <!--TODO 기업회원 리스트-->
    <select id="companyList" resultType="CompanyInfoDto">
        SELECT *,
               (SELECT COUNT(*) FROM regular r WHERE r.company_id = c.company_id) AS regularPeople ,
               (SELECT COUNT(*) FROM company_admin ca WHERE ca.company_id = c.company_id) AS adminPeople
        FROM company c
        LEFT JOIN member m ON m.mem_id = c.mem_id
        LEFT JOIN nation_info ni ON ni.nation_info_id = m.nation_info_id
        LEFT JOIN company_name cn ON cn.company_id = c.company_id
        LEFT JOIN member_status ms ON ms.mem_status_id = m.mem_status_id
        LEFT JOIN board_category bc ON bc.board_category_id = c.board_category_id
        <where>
            c.company_status = 2
            <if test="company.startDate != null and !company.startDate.equals('')">
                <![CDATA[
                        AND DATE(c.company_approval_date) >= DATE(#{company.startDate})
                    ]]>
            </if>

            <if test="company.endDate != null and !company.endDate.equals('')">
                <![CDATA[
                        AND DATE(c.company_approval_date) <= DATE(#{company.endDate})
                    ]]>
            </if>

            <!--TODO 주소 미정-->
            <if test="company.nationInfoId != null and company.nationInfoId != 0">
                AND m.nation_info_id = #{company.nationInfoId}
            </if>

            <choose>
                <when test="company.memStatusId != null and company.memStatusId != 0">
                    AND m.mem_status_id = #{company.memStatusId}
                </when>
                <otherwise>
                    AND (m.mem_status_id = 4 OR m.mem_status_id = 5 OR m.mem_status_id = 6)
                </otherwise>
            </choose>

            <choose>
                <when test="company.keywordFilter == 1">
                    AND m.mem_login_id LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 2">
                    AND bc.board_category_title LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 3">
                    AND (cn.company_name_eng LIKE CONCAT ('%', #{company.keyword}, '%') OR
                    cn.company_name_kor LIKE CONCAT ('%', #{company.keyword}, '%') OR
                    cn.company_name_php LIKE CONCAT ('%', #{company.keyword}, '%') OR
                    cn.company_name_chn LIKE CONCAT ('%', #{company.keyword}, '%') OR
                    cn.company_name_jpn LIKE CONCAT ('%', #{company.keyword}, '%'))
                </when>
                <when test="company.keywordFilter == 4">
                    AND c.company_address LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 5">
                    AND c.company_phone LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
            </choose>
        </where>
        ORDER BY c.company_approval_date DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!--TODO 기업회원 신청 카운트-->
    <select id="insCompanyCount" resultType="int">
        SELECT COUNT(*) FROM company c
        LEFT JOIN member m ON m.mem_id = c.mem_id
        LEFT JOIN company_name cn ON cn.company_id = c.company_id
        LEFT JOIN company_master cm ON cm.company_id = c.company_id
        LEFT JOIN nation_info ni ON ni.nation_info_id = m.nation_info_id
        LEFT JOIN member_status ms ON ms.mem_status_id = m.mem_status_id
        LEFT JOIN board_category bc ON bc.board_category_id = c.board_category_id
        <where>
            <if test="companyStatus != 0">
                c.company_status = #{companyStatus}
            </if>
            <if test="company.startDate != null and !company.startDate.equals('')">
                <![CDATA[
                        AND DATE(c.company_application_date) >= DATE(#{company.startDate})
                    ]]>
            </if>

            <if test="company.endDate != null and !company.endDate.equals('')">
                <![CDATA[
                        AND DATE(c.company_application_date) <= DATE(#{company.endDate})
                    ]]>
            </if>

            <if test="company.nationInfoId != null and company.nationInfoId != 0">
                AND m.nation_info_id = #{company.nationInfoId}
            </if>

            <choose>
                <when test="company.keywordFilter == 1">
                    AND cm.company_master_name LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 2">
                    AND m.mem_login_id LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 3">
                    AND cm.company_master_phone LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 4">
                    AND c.company_address LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
            </choose>
        </where>
    </select>

    <!--TODO 기업회원신청 리스트-->
    <select id="insCompanyList" resultType="CompanyInfoDto">
        SELECT *
        FROM company c
        LEFT JOIN member m ON m.mem_id = c.mem_id
        LEFT JOIN company_name cn ON cn.company_id = c.company_id
        LEFT JOIN company_master cm ON cm.company_id = c.company_id
        LEFT JOIN nation_info ni ON ni.nation_info_id = m.nation_info_id
        LEFT JOIN member_status ms ON ms.mem_status_id = m.mem_status_id
        LEFT JOIN board_category bc ON bc.board_category_id = c.board_category_id
        <where>
            <if test="companyStatus != 0">
                c.company_status = #{companyStatus}
            </if>
            <if test="company.startDate != null and !company.startDate.equals('')">
                <![CDATA[
                        AND DATE(c.company_application_date) >= DATE(#{company.startDate})
                    ]]>
            </if>

            <if test="company.endDate != null and !company.endDate.equals('')">
                <![CDATA[
                        AND DATE(c.company_application_date) <= DATE(#{company.endDate})
                    ]]>
            </if>

            <if test="company.nationInfoId != null and company.nationInfoId != 0">
                AND m.nation_info_id = #{company.nationInfoId}
            </if>

            <choose>
                <when test="company.keywordFilter == 1">
                    AND cm.company_master_name LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 2">
                    AND m.mem_login_id LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 3">
                    AND cm.company_master_phone LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
                <when test="company.keywordFilter == 4">
                    AND c.company_address LIKE CONCAT ('%', #{company.keyword}, '%')
                </when>
            </choose>
        </where>
        ORDER BY c.company_application_date DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!--TODO 기업회원 아이디 설렉트-->
    <select id="regularsCount" resultType="int">
        SELECT COUNT(*) FROM member m
        LEFT JOIN regular r ON r.mem_id = m.mem_id
        LEFT JOIN company c ON c.company_id = r.company_id
        LEFT JOIN company_name cn ON cn.company_id = c.company_id
        LEFT JOIN board_category bc ON bc.board_category_id = c.board_category_id
        LEFT JOIN member m2 ON m2.mem_id = c.mem_id
        LEFT JOIN nation_info ni ON ni.nation_info_id = m2.nation_info_id
        <where>
            c.company_status = 2 AND m.mem_id = #{regular.memId}
            <choose>
                <when test="regular.keywordFilter == 1">
                    AND bc.board_category_title LIKE CONCAT ('%', #{regular.keyword}, '%')
                </when>
                <when test="regular.keywordFilter == 2">
                    AND (cn.company_name_eng LIKE CONCAT ('%', #{regular.keyword}, '%') OR
                    cn.company_name_kor LIKE CONCAT ('%', #{regular.keyword}, '%') OR
                    cn.company_name_php LIKE CONCAT ('%', #{regular.keyword}, '%') OR
                    cn.company_name_chn LIKE CONCAT ('%', #{regular.keyword}, '%') OR
                    cn.company_name_jpn LIKE CONCAT ('%', #{regular.keyword}, '%'))
                </when>
                <when test="regular.keywordFilter == 3">
                    AND ni.nation_info_name LIKE CONCAT ('%', #{regular.keyword}, '%')
                </when>
                <when test="regular.keywordFilter == 3">
                    AND c.company_address LIKE CONCAT ('%', #{regular.keyword}, '%')
                </when>
                <when test="regular.keywordFilter == 3">
                    AND c.company_phone LIKE CONCAT ('%', #{regular.keyword}, '%')
                </when>
            </choose>
        </where>
    </select>

    <!--TODO 기업회원 pk 설렉트-->
    <select id="selectCompanyId" resultType="RegularInfoDto">
        SELECT r.company_id FROM member m
        LEFT JOIN regular r ON r.mem_id = m.mem_id
        LEFT JOIN company c ON c.company_id = r.company_id
        LEFT JOIN company_name cn ON cn.company_id = c.company_id
        LEFT JOIN member m2 ON m2.mem_id = c.mem_id
        LEFT JOIN board_category bc ON bc.board_category_id = c.board_category_id
        LEFT JOIN nation_info ni ON ni.nation_info_id = m2.nation_info_id
        <where>
            c.company_status = 2 AND m.mem_id = #{regular.memId}
            <choose>
                <when test="regular.keywordFilter == 1">
                    AND bc.board_category_title LIKE CONCAT ('%', #{regular.keyword}, '%')
                </when>
                <when test="regular.keywordFilter == 2">
                    AND (cn.company_name_eng LIKE CONCAT ('%', #{regular.keyword}, '%') OR
                    cn.company_name_kor LIKE CONCAT ('%', #{regular.keyword}, '%') OR
                    cn.company_name_php LIKE CONCAT ('%', #{regular.keyword}, '%') OR
                    cn.company_name_chn LIKE CONCAT ('%', #{regular.keyword}, '%') OR
                    cn.company_name_jpn LIKE CONCAT ('%', #{regular.keyword}, '%'))
                </when>
                <when test="regular.keywordFilter == 3">
                    AND ni.nation_info_name LIKE CONCAT ('%', #{regular.keyword}, '%')
                </when>
                <when test="regular.keywordFilter == 3">
                    AND c.company_address LIKE CONCAT ('%', #{regular.keyword}, '%')
                </when>
                <when test="regular.keywordFilter == 3">
                    AND c.company_phone LIKE CONCAT ('%', #{regular.keyword}, '%')
                </when>
            </choose>
        </where>
        LIMIT #{offset}, #{limit}
    </select>

    <!--TODO 기업회원 설렉트-->
    <select id="selectCompany" parameterType="int" resultType="CompanyInfoDto">
        SELECT *,(SELECT COUNT(*) FROM regular r WHERE r.company_id = c.company_id) AS regularPeople,
               (SELECT COUNT(*) FROM company_admin ca WHERE ca.company_id = c.company_id) AS adminPeople
        FROM company c
        LEFT JOIN member m ON m.mem_id = c.mem_id
        LEFT JOIN company_name cn ON cn.company_id = c.company_id
        LEFT JOIN company_master cm ON cm.company_id = c.company_id
        LEFT JOIN nation_info ni ON ni.nation_info_id = m.nation_info_id
        LEFT JOIN member_status ms ON ms.mem_status_id = m.mem_status_id
        LEFT JOIN board_category bc ON bc.board_category_id = c.board_category_id
        LEFT JOIN company_closed cc ON cc.company_id = c.company_id
        WHERE c.mem_id = #{memId}
    </select>

    <!--TODO 기업회원 설렉트-->
    <select id="selectCompanyInfo" resultType="CompanyInfoDto">
        SELECT *,(SELECT COUNT(*) FROM regular r WHERE r.company_id = c.company_id) AS regularPeople,
               (SELECT COUNT(*) FROM company_admin ca WHERE ca.company_id = c.company_id) AS adminPeople
        FROM company c
        LEFT JOIN member m ON m.mem_id = c.mem_id
        LEFT JOIN nation_info ni ON ni.nation_info_id = m.nation_info_id
        LEFT JOIN company_name cn ON cn.company_id = c.company_id
        LEFT JOIN company_master cm ON cm.company_id = c.company_id
        LEFT JOIN member_status ms ON ms.mem_status_id = m.mem_status_id
        LEFT JOIN board_category bc ON bc.board_category_id = c.board_category_id
        LEFT JOIN company_closed cc ON cc.company_id = c.company_id
        <where>
            c.company_id = #{companyId}
        </where>
    </select>

    <!--TODO 기업회원 상품 설렉트-->
    <select id="selectCompanyProduct" resultType="CompanyProduct">
        SELECT * FROM company_product
        WHERE company_id = #{companyId}
    </select>

    <!--TODO 기업 리뷰리스트 설렉트-->
    <select id="selectReviewsCount" resultType="int">
        SELECT COUNT(*) FROM company_review
        WHERE company_id = #{companyId}
    </select>

    <!--TODO 기업 리뷰리스트 설렉트-->
    <select id="selectReviewList" resultType="CompanyReviewInfoDto">
        SELECT * FROM company_review cr
        LEFT JOIN member m ON m.mem_id = cr.mem_id
        WHERE cr.company_id = #{companyId}
        LIMIT #{offset}, #{limit}
    </select>

    <!--TODO 기업 리뷰파일 설렉트-->
    <select id="selectReviewImages" resultType="CompanyReviewImage">
        SELECT * FROM company_review_image
        WHERE company_review_id = #{companyReviewId}
    </select>

    <!--TODO 기업 어드민 카운트-->
    <select id="selectCompanyAdminCount" resultType="int">
        SELECT COUNT(*) FROM company_admin
        WHERE company_id = #{companyId}
    </select>

    <!--TODO 기업 리뷰파일 설렉트-->
    <select id="selectCompanyAdminList" resultType="CompanyAdminInfoDto">
        SELECT * FROM company_admin ca
        LEFT JOIN member m ON m.mem_id = ca.mem_id
        WHERE ca.company_id = #{companyId}
        LIMIT #{offset}, #{limit}
    </select>

    <!--TODO 기업회원 이미지 설렉트-->
    <select id="selectCompanyImages" resultType="CompanyImage">
        SELECT * FROM company_image
        WHERE company_id = #{companyId}
    </select>

    <!--TODO 기업상품 이미지 설렉트-->
    <select id="selectCompanyProductImages" resultType="CompanyProductImage">
        SELECT * FROM company_product_image
        WHERE company_id = #{companyId}
    </select>

    <!--TODO 기업회원 ALL 설렉트-->
    <select id="selectCompanyAll" resultType="CompanyInfoDto">
        SELECT *,(SELECT COUNT(*) FROM regular r WHERE r.company_id = c.company_id) AS regularPeople FROM company c
        LEFT JOIN member m ON m.mem_id = c.mem_id
        LEFT JOIN nation_info ni ON ni.nation_info_id = m.nation_info_id
        LEFT JOIN company_name cn ON cn.company_id = c.company_id
        LEFT JOIN company_master cm ON cm.company_id = c.company_id
        LEFT JOIN member_status ms ON ms.mem_status_id = m.mem_status_id
        LEFT JOIN board_category bc ON bc.board_category_id = c.board_category_id
        LEFT JOIN company_closed cc ON cc.company_id = c.company_id
        WHERE c.company_status = 2
    </select>

    <!--TODO 기업회원 신청 ALL 설렉트-->
    <select id="selectInsCompanyAll" resultType="CompanyInfoDto">
        SELECT *,(SELECT COUNT(*) FROM regular r WHERE r.company_id = c.company_id) AS regularPeople FROM company c
        LEFT JOIN member m ON m.mem_id = c.mem_id
        LEFT JOIN nation_info ni ON ni.nation_info_id = m.nation_info_id
        LEFT JOIN company_name cn ON cn.company_id = c.company_id
        LEFT JOIN company_master cm ON cm.company_id = c.company_id
        LEFT JOIN member_status ms ON ms.mem_status_id = m.mem_status_id
        LEFT JOIN board_category bc ON bc.board_category_id = c.board_category_id
        LEFT JOIN company_closed cc ON cc.company_id = c.company_id
        WHERE c.company_status = 1 OR c.company_status = 2 OR c.company_status = 3
    </select>

    <!--TODO 국가 ALL 설렉트-->
    <select id="selectNation" resultType="NationInfo">
        SELECT nation_info_id, nation_info_name FROM nation_info
    </select>

    <!--TODO 기업회원 반려 사유 인서트-->
    <insert id="returnInsCompany">
        INSERT INTO company_return
        (company_id, company_return_contents, company_return_date)
        VALUES
        (#{company.companyId}, #{company.companyReturnContents}, #{company.companyReturnDate})
    </insert>

    <!--TODO 공공기업 업데이트-->
    <update id="changeCompanyAuth">
        UPDATE company c
        LEFT JOIN member m ON m.mem_id = c.mem_id
        SET c.company_public = #{companyPublic}
        <if test="status != 0">
            , m.mem_status_id = 4
            , c.company_status = 2
        </if>
        WHERE company_id = #{companyId}
    </update>

    <!--TODO 기업리뷰 업데이트-->
    <update id="changeReviewStatus">
        UPDATE company_review
        SET company_review_status = #{companyReviewStatus}
        WHERE company_review_id = #{companyReviewId}
    </update>

    <!--TODO 기업회원 상태 업데이트-->
    <update id="changeInsCompanyStatus">
        UPDATE company
        SET
            company_status = 2,
            company_approval_date = NOW()
        <where>
            <if test="memId != null and memId.size() != 0">
                <foreach item="memId" collection="memId" open="(" close=")" separator="OR">
                    mem_id = #{memId}
                </foreach>
            </if>
        </where>

    </update>

    <!--TODO 기업회원 반려 상태 업데이트-->
    <update id="returnUpdCompany">
        UPDATE company
        SET company_status = 3
        WHERE company_id = #{companyId}
    </update>

</mapper>